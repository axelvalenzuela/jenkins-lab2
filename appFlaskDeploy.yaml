  - hosts:
    become: true
    vars_files: secret.yaml
    tasks:
            - name: apt-update
              apt:
                  update_cache: yes
            - name: install docker
                apt:
                  name: docker.io
                  state: present
            - name: Create new directory
                become_user: avalenzuela
                file:
                  path: /home/avalenzuela/target
                  state: directory
            - name: copy the source code to hosts
              copy: src=./{{ item }} dest=/home/avalenzuela/target/
              become_user: avalenzuela
              with_items:
                  - app
                  - migrations
                  - flasky.py
                  - config.py
                  - boot.sh
                  - data-dev.sqlite
                  - Dockerfile
                  - requirements
            - name: Set the executable permissions
              command: chmod +X /home/avalenzuela/target/boot.sh
            - name: Build docker image
              command: chdir=/home/avalenzuela/target/ docker build . -t mediaapp
            - name: Run Docker Container
              command: chdir=/home/avalenzuela/target/ docker run -itd -e {{ SECRET_KEY }} -p 8085:5000 mediaapp

